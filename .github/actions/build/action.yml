name: Build element-web
description: Run within a checkout to build a webapp directory
inputs:
    config-path:
        required: false
        description: "Path to the config.json to use. Defaults to element.io/develop/config.json"
        default: "element.io/develop/config.json"
    matrix-js-sdk-sha:
        required: false
        description: "The Git SHA of matrix-js-sdk to build against. By default, will use a matching branch name if it exists, or develop."
runs:
    using: composite
    steps:
        - name: Fetch layered build
          id: layered_build
          env:
              # This must be set for fetchdep.sh to get the right branch
              PR_NUMBER: ${{ github.event.pull_request.number }}
              # tell layered.sh to check out the right sha of the JS-SDK & EW, if they were given one
              JS_SDK_GITHUB_BASE_REF: ${{ inputs.matrix-js-sdk-sha }}
          working-directory: ${{ github.action_path }}/../../..
          shell: bash
          run: |
              scripts/layered.sh
              JSSDK_SHA=$(git -C matrix-js-sdk rev-parse --short=12 HEAD)
              VECTOR_SHA=$(git rev-parse --short=12 HEAD)
              echo "VERSION=$VECTOR_SHA--js-$JSSDK_SHA" >> $GITHUB_OUTPUT

        - name: Copy config
          working-directory: ${{ github.action_path }}/../../..
          shell: bash
          run: cp "$CONFIG_PATH" config.json
          env:
              CONFIG_PATH: ${{ inputs.config-path }}

        - name: Build
          working-directory: ${{ github.action_path }}/../../..
          shell: bash
          env:
              CI_PACKAGE: true
              VERSION: "${{ steps.layered_build.outputs.VERSION }}"
          run: yarn build
